# ADR-005: Централизация обработки ошибок

## Статус
Принято

## Контекст
При разработке Language Exchange Bot возникла необходимость в единообразной обработке ошибок:

- Разные типы ошибок (Telegram API, Database, Redis, Validation)
- Необходимость логирования и мониторинга
- Уведомления администраторов о критических ошибках
- Пользовательские сообщения об ошибках
- Трассировка ошибок через систему

## Рассмотренные варианты

### 1. Разрозненная обработка ошибок
**Плюсы:**
- Простота реализации
- Локальный контроль

**Минусы:**
- Непоследовательность
- Дублирование кода
- Сложность мониторинга
- Отсутствие централизованного логирования

### 2. Panic/Recover подход
**Плюсы:**
- Простота
- Автоматическое восстановление

**Минусы:**
- Потеря контекста
- Сложность отладки
- Не подходит для production

### 3. Централизованная обработка ошибок
**Плюсы:**
- Единообразие
- Централизованное логирование
- Легкость мониторинга
- Консистентность

**Минусы:**
- Сложность реализации
- Потенциальная точка отказа

### 4. Error Wrapping (Go 1.13+)
**Плюсы:**
- Стандартный подход Go
- Хорошая трассировка
- Простота использования

**Минусы:**
- Нет автоматического логирования
- Отсутствие централизованного мониторинга

## Решение
Принят централизованный подход с типизированными ошибками и автоматическим логированием.

### Архитектура обработки ошибок:

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Application   │───▶│ Error Handler   │───▶│   Monitoring    │
│                 │    │                 │    │                 │
│ 1. Error Occurs │    │ 1. Categorize   │    │ 1. Logging      │
│ 2. Wrap Error   │    │ 2. Log Error    │    │ 2. Metrics      │
│ 3. Send to Handler│   │ 3. Notify Admin │    │ 3. Alerting     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Типы ошибок:

#### 1. **Telegram API Errors**
```go
type TelegramError struct {
    Code    string
    Message string
    ChatID  int64
    UserID  int64
    Cause   error
}
```

**Обработка:**
- Логирование с контекстом
- Уведомление администраторов
- Graceful degradation

#### 2. **Database Errors**
```go
type DatabaseError struct {
    Operation string
    Table     string
    Query     string
    Cause     error
}
```

**Обработка:**
- Логирование SQL запроса
- Circuit breaker активация
- Retry logic

#### 3. **Validation Errors**
```go
type ValidationError struct {
    Field   string
    Value   interface{}
    Rule    string
    Message string
}
```

**Обработка:**
- Пользовательские сообщения
- Логирование для отладки
- Не критично для системы

#### 4. **Cache Errors**
```go
type CacheError struct {
    Operation string
    Key       string
    Cause     error
}
```

**Обработка:**
- Fallback на database
- Логирование для мониторинга
- Не критично для системы

### Централизованный Error Handler:

```go
type ErrorHandler struct {
    notifier AdminNotifier
    logger   Logger
    metrics  MetricsCollector
}

func (h *ErrorHandler) Handle(err error, ctx *RequestContext) error {
    // 1. Категоризация ошибки
    errorType := h.categorizeError(err)
    
    // 2. Логирование
    h.logError(err, ctx, errorType)
    
    // 3. Метрики
    h.recordMetrics(errorType)
    
    // 4. Уведомления (для критических ошибок)
    if h.isCritical(errorType) {
        h.notifyAdmins(err, ctx)
    }
    
    return err
}
```

### Контекст запроса:

```go
type RequestContext struct {
    RequestID string
    UserID    int64
    ChatID    int64
    Operation string
    Timestamp time.Time
}
```

## Последствия

### Положительные
- **Единообразие**: Консистентная обработка ошибок
- **Мониторинг**: Централизованное логирование и метрики
- **Отладка**: Легче найти и исправить проблемы
- **Пользовательский опыт**: Понятные сообщения об ошибках
- **Администрирование**: Автоматические уведомления

### Отрицательные
- **Сложность**: Дополнительная абстракция
- **Производительность**: Накладные расходы на обработку
- **Зависимость**: Центральная точка отказа
- **Настройка**: Требует тщательной настройки

## Мониторинг и алерты

### Метрики:
- **Error Rate**: Процент ошибок по типам
- **Error Frequency**: Частота ошибок в секунду
- **Recovery Time**: Время восстановления после ошибок
- **User Impact**: Количество затронутых пользователей

### Алерты:
- Критические ошибки (>5 в минуту)
- Высокий процент ошибок (>10%)
- Недоступность внешних сервисов
- Необычные паттерны ошибок

## Логирование

### Структура логов:
```json
{
  "timestamp": "2025-01-XXT10:30:00Z",
  "level": "ERROR",
  "request_id": "req_123456",
  "user_id": 12345,
  "chat_id": 67890,
  "operation": "send_message",
  "error_type": "telegram_api",
  "error_code": "TELEGRAM_API_ERROR",
  "message": "Failed to send message",
  "cause": "Network timeout",
  "stack_trace": "..."
}
```

### Уровни логирования:
- **DEBUG**: Детальная информация для отладки
- **INFO**: Общая информация о работе
- **WARN**: Предупреждения о потенциальных проблемах
- **ERROR**: Ошибки, не критичные для системы
- **FATAL**: Критические ошибки, требующие вмешательства

## Связанные решения
- ADR-001: Принятие Clean Architecture (структура пакетов)
- ADR-002: Стратегия кэширования с Redis (обработка cache ошибок)
- ADR-003: Паттерн Circuit Breaker (интеграция с error handling)
