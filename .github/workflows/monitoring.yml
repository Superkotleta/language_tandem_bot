name: Monitoring & Alerts

on:
  schedule:
    - cron: '*/5 * * * *'  # ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check production health
      run: |
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ health endpoints
        HEALTH_URL="${{ secrets.SERVER_URL }}/healthz"
        READY_URL="${{ secrets.SERVER_URL }}/readyz"
        
        echo "ğŸ” Checking production health..."
        
        # Health check
        if curl -f -s --max-time 10 "$HEALTH_URL" > /dev/null; then
          echo "âœ… Health check passed"
        else
          echo "âŒ Health check failed"
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ğŸš¨ Language Exchange Bot Health Check Failed!"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}
          exit 1
        fi
        
        # Readiness check
        if curl -f -s --max-time 10 "$READY_URL" > /dev/null; then
          echo "âœ… Readiness check passed"
        else
          echo "âŒ Readiness check failed"
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ğŸš¨ Language Exchange Bot Readiness Check Failed!"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}
          exit 1
        fi
    
    - name: Performance metrics
      run: |
        # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
        API_URL="${{ secrets.SERVER_URL }}/api/v1/stats"
        
        echo "ğŸ“Š Collecting performance metrics..."
        
        RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' "$API_URL")
        echo "Response time: ${RESPONSE_TIME}s"
        
        # Ğ•ÑĞ»Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½ĞµĞµ 2 ÑĞµĞºÑƒĞ½Ğ´ - Ğ°Ğ»ĞµÑ€Ñ‚
        if (( $(echo "$RESPONSE_TIME > 2.0" | bc -l) )); then
          echo "âš ï¸ Slow response detected: ${RESPONSE_TIME}s"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âš ï¸ Language Exchange Bot Slow Response: ${RESPONSE_TIME}s\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }}
        fi
    
    - name: Database connectivity
      run: |
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ‘Ğ” Ñ‡ĞµÑ€ĞµĞ· API
        DB_URL="${{ secrets.SERVER_URL }}/api/v1/stats"
        
        if curl -f -s --max-time 10 "$DB_URL" > /dev/null; then
          echo "âœ… Database connectivity OK"
        else
          echo "âŒ Database connectivity failed"
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ğŸš¨ Language Exchange Bot Database Connection Failed!"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}
        fi
